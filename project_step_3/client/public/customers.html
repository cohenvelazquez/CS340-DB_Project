<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers - Banana Phone Estate Services</title>
    <link rel="stylesheet" href="styles.css">
    <script src="data.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Customer Management</h1>
            <nav class="breadcrumb">
                <a href="index.html">Home</a> > Customers
            </nav>
        </header>

        <div class="action-bar">
            <a href="customers-add.html" class="btn btn-primary">+ Add New Customer</a>
            <div class="search-box">
                <input type="text" placeholder="Search customers..." id="searchCustomers">
                <button class="btn btn-secondary">Search</button>
            </div>
        </div>

        <div class="table-container">
                        <table class="data-table" id="customersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Customer Since</th>
                        <th>Total Purchases</th>
                        <th>Sales Count</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customersTableBody">
                    <!-- Data populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="stats-summary">
            <div class="stat-card">
                <span class="stat-number">5</span>
                <span class="stat-label">Total Customers</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">4</span>
                <span class="stat-label">Active Buyers</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">$830.00</span>
                <span class="stat-label">Total Spent</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">$207.50</span>
                <span class="stat-label">Avg per Customer</span>
            </div>
        </div>
    </div>

    <script>
        // Function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        // Function to format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Function to populate customers table
        function populateCustomersTable() {
            const customers = getAllCustomers();
            const tbody = document.querySelector('.data-table tbody');
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.customerID}</td>
                    <td>${customer.firstName} ${customer.lastName}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${formatDate(customer.created_at)}</td>
                    <td>${customer.numberOfSales}</td>
                    <td>${formatCurrency(customer.totalPurchases)}</td>
                    <td>
                        <button class="btn btn-small" onclick="viewCustomer(${customer.customerID})">View</button>
                        <button class="btn btn-small" onclick="editCustomer(${customer.customerID})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteCustomer(${customer.customerID})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateCustomerStats(customers);
        }

        // Function to update statistics
        function updateCustomerStats(customers) {
            const totalCustomers = customers.length;
            const totalSpent = customers.reduce((sum, customer) => sum + customer.totalPurchases, 0);
            const avgPerCustomer = totalCustomers > 0 ? totalSpent / totalCustomers : 0;
            const activeCustomers = customers.filter(customer => customer.numberOfSales > 0).length;
            
            // Update stat cards
            const statNumbers = document.querySelectorAll('.stat-number');
            statNumbers[0].textContent = totalCustomers; // Total Customers
            statNumbers[1].textContent = activeCustomers; // Active Customers
            statNumbers[2].textContent = formatCurrency(totalSpent); // Total Spent
            statNumbers[3].textContent = formatCurrency(avgPerCustomer); // Avg per Customer
        }

        // Function to search customers
        function searchCustomers() {
            const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
            const allCustomers = getAllCustomers();
            
            const filteredCustomers = allCustomers.filter(customer => 
                customer.firstName.toLowerCase().includes(searchTerm) ||
                customer.lastName.toLowerCase().includes(searchTerm) ||
                customer.email.toLowerCase().includes(searchTerm) ||
                customer.phone.includes(searchTerm)
            );
            
            // Re-populate table with filtered data
            const tbody = document.querySelector('.data-table tbody');
            tbody.innerHTML = '';
            
            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.customerID}</td>
                    <td>${customer.firstName} ${customer.lastName}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${formatDate(customer.created_at)}</td>
                    <td>${customer.numberOfSales}</td>
                    <td>${formatCurrency(customer.totalPurchases)}</td>
                    <td>
                        <button class="btn btn-small" onclick="viewCustomer(${customer.customerID})">View</button>
                        <button class="btn btn-small" onclick="editCustomer(${customer.customerID})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteCustomer(${customer.customerID})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateCustomerStats(filteredCustomers);
        }

        // Action functions
        function viewCustomer(customerId) {
            window.location.href = `customer-details.html?customerId=${customerId}`;
        }

        function editCustomer(customerId) {
            window.location.href = `edit-customer.html?customerId=${customerId}`;
        }

        function deleteCustomer(customerId) {
            const customers = getAllCustomers();
            const customer = customers.find(c => c.customerID == customerId);
            
            if (!customer) {
                alert('Customer not found');
                return;
            }

            // Check if customer has sales
            if (customer.numberOfSales > 0) {
                alert('Cannot delete customers with existing sales. Please remove sales first.');
                return;
            }

            if (confirm(`Are you sure you want to delete ${customer.firstName} ${customer.lastName}? This action cannot be undone.`)) {
                alert(`Deleted customer ${customer.firstName} ${customer.lastName}`);
                populateCustomersTable();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            populateCustomersTable();
            
            // Add event listeners if elements exist
            const searchInput = document.getElementById('searchCustomers');
            
            if (searchInput) {
                searchInput.addEventListener('input', searchCustomers);
            }
        });
    </script>
</body>
</html>
