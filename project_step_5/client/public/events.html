<!DOCTYPE html>
<!--
Banana Phone Estate Services - Estate Sale Events Management Page
Authors: Cohen Velazquez and Joseph Lucciano Barberan
Group: 80
Date: August 7-14, 2025
Course: CS 340 - Databases, Oregon State University

Original frontend implementation with responsive design and dynamic data loading.
Enhanced with assistance from AI generative tools (GitHub Copilot) for code optimization.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Banana Phone Estate Services</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Estate Sale Events</h1>
            <nav class="breadcrumb">
                <a href="index.html">Home</a> > Events
            </nav>
            <div class="header-actions">
                <button id="resetBtn" class="reset-btn">RESET DATABASE</button>
            </div>
        </header>

        <div class="action-bar">
            <a href="events-add.html" class="btn btn-primary">+ Add New Event</a>
            <div class="search-box">
                <input type="text" placeholder="Search events..." id="searchEvents">
                <button class="btn btn-secondary" onclick="searchEvents()">Search</button>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table" id="eventsTable">
                <thead>
                    <tr>
                        <th>Event ID</th>
                        <th>Title</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Location</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="eventsTableBody">
                    <!-- Data populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="stats-summary">
            <div class="stat-card">
                <span class="stat-number" id="totalEvents">0</span>
                <span class="stat-label">Total Events</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="upcomingEvents">0</span>
                <span class="stat-label">Upcoming</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="activeEvents">0</span>
                <span class="stat-label">Active</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="completedEvents">0</span>
                <span class="stat-label">Completed</span>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        let eventsData = [];

        // Function to reset the database
        async function resetDatabase() {
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.disabled = true;
            resetBtn.textContent = 'RESETTING...';
            
            try {
                await databaseAPI.reset();
                await loadEvents();
            } catch (error) {
                console.error('Reset error:', error);
            } finally {
                resetBtn.disabled = false;
                resetBtn.textContent = 'RESET DATABASE';
            }
        }

        // Load events data
        async function loadEvents() {
            try {
                eventsData = await eventsAPI.getAll();
                renderEventsTable();
                updateStatistics();
            } catch (error) {
                console.error('Error loading events:', error);
                showMessage('Failed to load events: ' + error.message, 'error');
            }
        }

        // Render events table
        function renderEventsTable() {
            const tableBody = document.getElementById('eventsTableBody');
            
            const columns = [
                { field: 'eventID' },
                { field: 'title' },
                { 
                    field: 'startDate', 
                    formatter: (value) => formatDateForDisplay(value) 
                },
                { 
                    field: 'endDate', 
                    formatter: (value) => formatDateForDisplay(value) 
                },
                { 
                    field: 'location',
                    formatter: (value) => value.length > 50 ? value.substring(0, 50) + '...' : value
                },
                { 
                    field: 'description',
                    formatter: (value) => value && value.length > 100 ? value.substring(0, 100) + '...' : (value || '')
                },
                {
                    field: 'actions',
                    formatter: (value, row) => `
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editEvent(${row.eventID})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${row.eventID}, &quot;${row.title.replace(/"/g, '&quot;')}&quot;)">
                                Delete
                            </button>
                        </div>
                    `
                }
            ];

            populateTable('eventsTable', eventsData, columns);
        }

        // Edit event function
        function editEvent(eventId) {
            window.location.href = `edit-event.html?id=${eventId}`;
        }

        // Delete event function
        async function deleteEvent(eventId, eventTitle) {
            if (!confirm(`Are you sure you want to delete event "${eventTitle}"? This will also delete all associated items.`)) {
                return;
            }

            try {
                await eventsAPI.delete(eventId);
                await loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
            }
        }

        // Search functionality
        function searchEvents() {
            const searchTerm = document.getElementById('searchEvents').value.toLowerCase();
            
            if (!searchTerm) {
                renderEventsTable();
                return;
            }

            const filteredData = eventsData.filter(event => 
                event.title.toLowerCase().includes(searchTerm) ||
                event.location.toLowerCase().includes(searchTerm) ||
                (event.description && event.description.toLowerCase().includes(searchTerm))
            );

            const tableBody = document.getElementById('eventsTableBody');
            const columns = [
                { field: 'eventID' },
                { field: 'title' },
                { 
                    field: 'startDate', 
                    formatter: (value) => formatDateForDisplay(value) 
                },
                { 
                    field: 'endDate', 
                    formatter: (value) => formatDateForDisplay(value) 
                },
                { 
                    field: 'location',
                    formatter: (value) => value.length > 50 ? value.substring(0, 50) + '...' : value
                },
                { 
                    field: 'description',
                    formatter: (value) => value && value.length > 100 ? value.substring(0, 100) + '...' : (value || '')
                },
                {
                    field: 'actions',
                    formatter: (value, row) => `
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editEvent(${row.eventID})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${row.eventID}, &quot;${row.title.replace(/"/g, '&quot;')}&quot;)">
                                Delete
                            </button>
                        </div>
                    `
                }
            ];

            populateTable('eventsTable', filteredData, columns);
        }

        // Update statistics
        function updateStatistics() {
            const now = new Date();
            let upcomingEvents = 0;
            let activeEvents = 0;
            let completedEvents = 0;

            eventsData.forEach(event => {
                const startDate = new Date(event.startDate);
                const endDate = new Date(event.endDate);

                if (now < startDate) {
                    upcomingEvents++;
                } else if (now >= startDate && now <= endDate) {
                    activeEvents++;
                } else {
                    completedEvents++;
                }
            });

            document.getElementById('totalEvents').textContent = eventsData.length;
            document.getElementById('upcomingEvents').textContent = upcomingEvents;
            document.getElementById('activeEvents').textContent = activeEvents;
            document.getElementById('completedEvents').textContent = completedEvents;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchEvents');

            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchEvents();
                    }
                });
            }

            // Add reset button event listener
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetDatabase);
            }

            // Load events when page loads
            loadEvents();
        });
    </script>
</body>
</html>
