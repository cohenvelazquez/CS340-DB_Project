<!DOCTYPE html>
<!--
Banana Phone Estate Services - Sales Management Page
Authors: Cohen Velazquez and Joseph Lucciano Barberan
Group: 80
Date: August 7-14, 2025
Course: CS 340 - Databases, Oregon State University

Original frontend implementation with responsive design and dynamic data loading.
Enhanced with assistance from AI generative tools (GitHub Copilot) for code optimization.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales - Banana Phone Estate Services</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Sales Management</h1>
            <nav class="breadcrumb">
                <a href="index.html">Home</a> > Sales
            </nav>
            <div class="header-actions">
                <button id="resetBtn" class="reset-btn">RESET DATABASE</button>
            </div>
        </header>

        <div class="action-bar">
            <a href="sales-add.html" class="btn btn-primary">+ Add New Sale</a>
            <div class="filter-controls">
                <select id="customerFilter">
                    <option value="">All Customers</option>
                </select>
                <select id="paymentFilter">
                    <option value="">All Payment Methods</option>
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Check">Check</option>
                </select>
                <input type="text" placeholder="Search sales..." id="searchSales">
                <button class="btn btn-secondary" onclick="searchSales()">Search</button>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table" id="salesTable">
                <thead>
                    <tr>
                        <th>Sale ID</th>
                        <th>Customer</th>
                        <th>Sale Date</th>
                        <th>Total Amount</th>
                        <th>Payment Method</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <!-- Data populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="stats-summary">
            <div class="stat-card">
                <span class="stat-number" id="totalSales">0</span>
                <span class="stat-label">Total Sales</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalRevenue">$0.00</span>
                <span class="stat-label">Total Revenue</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="avgSaleAmount">$0.00</span>
                <span class="stat-label">Avg Sale Amount</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="todaySales">0</span>
                <span class="stat-label">Today's Sales</span>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        let salesData = [];
        let customersData = [];

        // Function to reset the database
        async function resetDatabase() {
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.disabled = true;
            resetBtn.textContent = 'RESETTING...';
            
            try {
                await databaseAPI.reset();
                await loadSales();
                await loadCustomers();
            } catch (error) {
                console.error('Reset error:', error);
            } finally {
                resetBtn.disabled = false;
                resetBtn.textContent = 'RESET DATABASE';
            }
        }

        // Load sales data
        async function loadSales() {
            try {
                console.log('Loading sales...');
                console.log('salesAPI:', typeof salesAPI);
                
                if (typeof salesAPI === 'undefined') {
                    throw new Error('salesAPI is not defined. Check if data.js loaded properly.');
                }
                
                salesData = await salesAPI.getAll();
                console.log('Sales loaded:', salesData.length);
                
                renderSalesTable();
                updateStatistics();
            } catch (error) {
                console.error('Error loading sales:', error);
                showMessage('Failed to load sales: ' + error.message, 'error');
                
                // Show error in table
                const tableBody = document.getElementById('salesTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="7">Error loading sales data</td></tr>';
                }
            }
        }

        // Load customers for dropdown
        async function loadCustomers() {
            try {
                console.log('Loading customers for dropdown...');
                console.log('customersAPI:', typeof customersAPI);
                
                if (typeof customersAPI === 'undefined') {
                    throw new Error('customersAPI is not defined. Check if data.js loaded properly.');
                }
                
                customersData = await customersAPI.getForDropdown();
                console.log('Customers for dropdown loaded:', customersData.length);
                populateCustomerFilter();
            } catch (error) {
                console.error('Error loading customers:', error);
                // Fallback to regular customers API
                try {
                    customersData = await customersAPI.getAll();
                    populateCustomerFilter();
                } catch (fallbackError) {
                    console.error('Fallback customers load failed:', fallbackError);
                }
            }
        }

        // Populate customer filter dropdown
        function populateCustomerFilter() {
            const customerFilter = document.getElementById('customerFilter');
            customerFilter.innerHTML = '<option value="">All Customers</option>';
            
            customersData.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.customerID;
                option.textContent = customer.fullName;
                customerFilter.appendChild(option);
            });
        }

        // Render sales table
        function renderSalesTable() {
            console.log('Rendering sales table...', salesData);
            const tableBody = document.getElementById('salesTableBody');
            
            if (!tableBody) {
                console.error('Sales table body element not found!');
                return;
            }
            
            if (typeof populateTable === 'undefined') {
                console.error('populateTable function is not defined!');
                return;
            }
            
            // Check if we have data
            if (!salesData || salesData.length === 0) {
                console.log('No sales data to display');
                tableBody.innerHTML = '<tr><td colspan="6">No sales found</td></tr>';
                return;
            }
            
            const columns = [
                { field: 'saleID' },
                { field: 'customerName' },
                { 
                    field: 'saleDate', 
                    formatter: (value) => formatDateForDisplay(value) 
                },
                { 
                    field: 'totalAmount', 
                    formatter: (value) => formatCurrency(value) 
                },
                { field: 'paymentMethod' },
                {
                    field: 'actions',
                    formatter: (value, row) => `
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editSale(${row.saleID})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSale(${row.saleID}, '${row.customerName}')">
                                Delete
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewSaleItems(${row.saleID})">
                                Items
                            </button>
                        </div>
                    `
                }
            ];

            console.log('Calling populateTable with sales data:', salesData.length, 'sales');
            populateTable('salesTable', salesData, columns);
            console.log('populateTable call completed');
        }

        // Edit sale function
        function editSale(saleId) {
            window.location.href = `edit-sale.html?id=${saleId}`;
        }

        // Delete sale function
        async function deleteSale(saleId, customerName) {
            if (!confirm(`Are you sure you want to delete this sale for ${customerName}? This will return all items to Available status.`)) {
                return;
            }

            try {
                await salesAPI.delete(saleId);
                await loadSales();
            } catch (error) {
                console.error('Error deleting sale:', error);
            }
        }

        // View sale items function
        function viewSaleItems(saleId) {
            window.location.href = `solditems.html?saleId=${saleId}`;
        }

        // Search functionality
        function searchSales() {
            const searchTerm = document.getElementById('searchSales').value.toLowerCase();
            const customerFilter = document.getElementById('customerFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            
            let filteredData = salesData;

            // Apply text search
            if (searchTerm) {
                filteredData = filteredData.filter(sale => 
                    sale.customerName.toLowerCase().includes(searchTerm) ||
                    sale.saleID.toString().includes(searchTerm)
                );
            }

            // Apply customer filter
            if (customerFilter) {
                filteredData = filteredData.filter(sale => sale.customerID == customerFilter);
            }

            // Apply payment method filter
            if (paymentFilter) {
                filteredData = filteredData.filter(sale => sale.paymentMethod === paymentFilter);
            }

            const tableBody = document.getElementById('salesTableBody');
            const columns = [
                { field: 'saleID' },
                { field: 'customerName' },
                { 
                    field: 'saleDate', 
                    formatter: (value) => formatDateForDisplay(value) 
                },
                { 
                    field: 'totalAmount', 
                    formatter: (value) => formatCurrency(value) 
                },
                { field: 'paymentMethod' },
                {
                    field: 'actions',
                    formatter: (value, row) => `
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editSale(${row.saleID})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSale(${row.saleID}, '${row.customerName}')">
                                Delete
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewSaleItems(${row.saleID})">
                                Items
                            </button>
                        </div>
                    `
                }
            ];

            populateTable('salesTable', filteredData, columns);
        }

        // Update statistics
        function updateStatistics() {
            const totalSales = salesData.length;
            const totalRevenue = salesData.reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);
            const avgSaleAmount = totalSales > 0 ? totalRevenue / totalSales : 0;
            
            // Calculate today's sales
            const today = new Date().toDateString();
            const todaySales = salesData.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate.toDateString() === today;
            }).length;

            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('avgSaleAmount').textContent = formatCurrency(avgSaleAmount);
            document.getElementById('todaySales').textContent = todaySales;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchSales');
            const customerFilter = document.getElementById('customerFilter');
            const paymentFilter = document.getElementById('paymentFilter');

            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchSales();
                    }
                });
            }

            if (customerFilter) {
                customerFilter.addEventListener('change', searchSales);
            }

            if (paymentFilter) {
                paymentFilter.addEventListener('change', searchSales);
            }

            // Add reset button event listener
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetDatabase);
            }

            // Load data when page loads
            loadSales();
            loadCustomers();
        });
        
        // Debug functions - can be called from browser console
        window.testSalesAPI = async function() {
            try {
                console.log('Testing sales API...');
                const response = await fetch('/api/sales');
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                return data;
            } catch (error) {
                console.error('API test failed:', error);
                return error;
            }
        };
        
        window.testResetAPI = async function() {
            try {
                console.log('Testing reset API...');
                const response = await fetch('/api/reset', { method: 'POST' });
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                return data;
            } catch (error) {
                console.error('Reset API test failed:', error);
                return error;
            }
        };
        
        // Make salesData available for debugging
        window.getSalesData = () => salesData;
    </script>
</body>
</html>
